{% extends '::base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets '@FMSymSlateBundle/Resources/public/css/translate.css' %}
	    <link rel="stylesheet" href="{{ asset_url }}" />
	{% endstylesheets %}
{% endblock %}

{% block javascripts %}
		{{ parent() }}
		
		{% javascripts '@FMSymSlateBundle/Resources/public/js/translate.js' %}
		    <script src="{{ asset_url }}"></script>
		{% endjavascripts %}
		
		<script type="text/javascript" src="{{ asset('vendor/ckeditor/ckeditor.js') }}"></script>
		
		<script type="text/javascript">
			//this is here and not in translate.js because we need some twig helpers for URLs, so this is more convenient.
			submit_translation = function(message_id, classification_id, translation_id, language_id)
			{
				var text = '';
				var txtid = 'translation_text_'+classification_id;
				if($('#'+txtid).hasClass('HTML'))
				{
					text = CKEDITOR.instances[txtid].getData();
				}
				else
				{
					text = $('#'+txtid).val();
				}

				var img = $('#translation_submit_'+classification_id);

				img.attr('src','{{ asset('bundles/fmsymslate/images/working.png') }}');

				$('#submission_feedback_'+classification_id).hide();
				
				$.post('../submissions/create',{
						message_id: message_id,
						classification_id: classification_id,
						translation_id: translation_id,
						language_id: language_id,
						text: text
					},
					function(data){
						console.log(data);
						if(data.success)
						{
							img.attr('src','{{ asset('bundles/fmsymslate/images/happy.png') }}');

							$('#submission_feedback_'+classification_id).css('display','none');
							$('#submission_feedback_'+classification_id).html(data['']);
							
						}
						else
						{
							img.attr('src','{{ asset('bundles/fmsymslate/images/sad.png') }}');
							
							$('#submission_feedback_'+classification_id).html(data['error_message']);
							$('#submission_feedback_'+classification_id).css('display','inline-block');
						}
					},
					'json');
			}

			CKEDITOR.on('currentInstance',function(e){
				var editor = CKEDITOR.currentInstance;
				if(editor){
					var tmp = editor.name.split("_");
					var id  = tmp[tmp.length - 1];
					gotFocus(id);
				}
			});

			$('textarea.translate').focus(function(e){
				var tmp = $(e.target).attr('id').split("_");
				var id  = tmp[tmp.length - 1];
				gotFocus(id);
			});

			function gotFocus(id)
			{
				$('.controls_active').removeClass('controls_active').css('display','none');
				console.log("I got the focus! " + id);
				$('#controls_'+id).css('display','table').addClass('controls_active');
			}
						
		</script>
		
{% endblock %}
{% block body %}
			<form class="form-inline translate">
		  		
				<input type="hidden" name="page" id="page" value="{{ app.request.query.get('page') | default(1) }}"/>

		  		<fieldset class="pull-left bordered">
		  			<legend>Language</legend>
		  			<label for="translate_source_language_code" class="input-label small">From</label>
			  		<select class="autosubmit" id="translate_source_language_code" name="source_language_code">
						{% for language in languages %}
							<option value="{{ language.code }}" {{ app.request.query.get('source_language_code')==language.code ? "selected='true'" : '' }}>{{ language.name }}</option>
						{% endfor %}
					</select>
					<br/>
					<label for="translate_language_code" class="input-label small">Into</label>
					<select class="autosubmit" id="translate_language_code" name="language_code">
						{% for language in languages %}
							<option value="{{ language.code }}" {{ app.request.query.get('language_code')==language.code ? "selected='true'" : '' }}>{{ language.name }}</option>
						{% endfor %}
					</select>
					
				</fieldset>
			  
			<div class="pull-left">
				<fieldset class="pull-left bordered">
					<legend>Message</legend>
					<label for = "message_like" class="input-label medium">Filter</label>
					<input id="message_like" name="message_like" type='text' value='{{ app.request.query.get('message_like')}}' placeholder="Filter messages..."/>
					<br/>
					<label for="translate_category" class="input-label medium">Category</label>
					<select style="" class="autosubmit" id="translate_category" name="category">
						<option value="">Any Category</option>
						{% for category in categories %}
							<option value="{{ category["category"] }}" {{ app.request.query.get('category')==category['category'] ? "selected='true'" : '' }}>
								{{ category["category"] }}
							</option>
						{% endfor %}
					</select>
				</fieldset>

				<fieldset class="pull-left bordered">
					<legend>Translation</legend>
					<label for="translation_like" class="input-label medium">Filter</label>
					<input type='text' id="translation_like" name="translation_like" value='{{ app.request.query.get('translation_like')}}' placeholder="Filter translations..."/>
					<br/>
					<label for="translate_empty" class="input-label medium">Status</label>
					<select  class="autosubmit" id="translate_empty" name="empty">
						<option value="ONLY" {{ app.request.query.get('empty')== "ONLY" ? "selected='true'" : '' }}>missing</option>
						<option value="EXCEPT" {{ app.request.query.get('empty')== "EXCEPT" ? "selected='true'" : '' }}>there</option>
						<option value="MAYBE" {{ app.request.query.get('empty')== "MAYBE" ? "selected='true'" : '' }}>there or not</option>
					</select>
					
					
				</fieldset>
			</div>
			<button type="submit" id="submit_translation_filter" class="btn btn-primary">Go!</button>
			
				<div class="clearfix"></div>
			  	

			</form>

			<br/>

			{% if pagination is not empty %}
				<div class='pagination'>

					<ul>
						{% for page, text in pagination %}<li><a href="javascript:goto_page({{ page }})">{{ text }}</a></li>{% endfor %}
					</ul>
				</div>
			{% endif %}
			
		</form>
	</fieldset>
	
	{% if pack == null %}
		<p><span class="error">The pack you are trying to translate does not exist!</span></p>	
	{% endif %}
	
	{% if language == null %}
		<p><span class="error">The language you are trying to translate into does not exist!</span></p>	
	{% endif %}
	
	{% if language and pack %}
		{% if messages == null %}
			<p><span class="info">There are no messages to translate here!</span></p>
		{% else %}
			{% for category, s_ss in messages %}
				<fieldset class="translate_category">
					<legend class="toggleable clickable">{{ category }}</legend>
					<div class="toggleable">
					{% for section, ss_m in s_ss %}	
						{% if section is not empty %}
							<fieldset class="translate_section">
								<legend class="toggleable clickable">{{ section }}</legend>
								<div class="toggleable">
						{% endif %}				
							{% for subsection, ms in ss_m %}

									{%  for m in ms %}

										<div class="translate_row {{ cycle(['odd', 'even'], loop.index) }}">


											<div class="translate_row_right">
												<img 
													 class="clickable small submit_translation" 
													 onclick="javascript:submit_translation({{ m['message_id'] }}, 
													 									 	{{ m['classification_id'] }},
													 									 	{{ m['translation_id'] | default('undefined') }},
													 									 	{{ language.getId() }})" 
													 src="{{ asset('bundles/fmsymslate/images/submit.png') }}"
													 alt="Submit!" 
													 id="translation_submit_{{ m['classification_id'] }}"
												 />
											</div>

											<div class="translate_row_left">
												<div class="translate_row_message pull-left " id="translation_message_{{ m['classification_id'] }}">
													
													{% if m['type'] == "HTML" %}
														<iframe id="iframe_{{ m['classification_id'] }}" class="translate" srcdoc="{{ m['text'] }}"></iframe>
													{% elseif m['type'] == "TXT" %}
														<pre class="translate">{{ m['text'] }}</pre>
													{% else %}
														{{ m['text'] }}
													{% endif %}
												
												
												</div>
												<div class="translate_row_translation pull-right">
													
													<textarea ckadjust="iframe_{{ m['classification_id'] }}" same_height="translation_message_{{ m['classification_id'] }}" id="translation_text_{{ m['classification_id'] }}" class="translate {{ m['type'] }}">{{ m['translation'] }}</textarea>
													
													
												</div>
											</div>

											
										</div>
										<div class="clearfix"></div>		
										
									{%  endfor %}
								
							{% endfor %}
						{% if section is not empty %}
							</div>
							</fieldset>
						{% endif %}
					{% endfor %}
				</div>
				</fieldset>
			{% endfor %}
		{% endif %}	
	{% endif %}

{% endblock %}