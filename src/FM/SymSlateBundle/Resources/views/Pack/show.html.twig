{% extends '::base.html.twig' %}

{% block javascripts %}
	<script type="text/javascript">

		function generate(url)
		{
			$.post(url,{},function(data){
				console.log(data);
			},
			'json');
		}

		$('#gzip_language').change(function(e){
			var info_url = "{{ path('latest_export_info', {'pack_id': entity.id, 'language_code': 'xx'}) }}".replace('xx',$(e.target).val());
			console.log(info_url);
			$.getJSON(info_url, function(data){
				console.log(data);
				if(data['success'] && data['found'])
				{
					$('#download_link').html('<a class="label label-info" href="'+data['web_path']+'">Download GZIP, generated on '+data['created']+'</a>')
				}
				else
				{
					$('#download_link').html('<span class="label label-warning">This pack was never generated, please generate it!</span>');
				}

				if(data['success'])
				{
					$('#generate_link').html('<a onclick="javascript:generate(\''+data['generate_path']+'\')" class="label label-success">Generate GZIP</a>');
				}
				else
				{
					$('#generate_link').html('');
				}
			});
		});
	</script>
{% endblock %}

{%  block body %}
	<h1>Pack &amp; translations management interface</h1>

	<h2>Info</h2>
	<p>
		{% if entity.getIsCurrent() %}
			<span class="label label-info">This is the latest pack, please help translating it fully!</span>
		{% else %}
			This pack is available but it is not the latest pack, please consider translating the latest one!
		{% endif %}
	</p>
	
	<table class="table table-condensed table-small">
	    <tbody>
	        <tr>
	            <th>Project</th>
	            <td>{{ entity.project }}</td>
	        </tr>
	        <tr>
	            <th>Name</th>
	            <td>{{ entity.name }}</td>
	        </tr>
	        <tr>
	            <th>Version</th>
	            <td>{{ entity.version }}</td>
	        </tr>
	    </tbody>
	</table>
	
	<br/>
	
	<h2>Quick access to translations</h2>

	<form class="form-inline translate" action="{{ path('translate', {'pack_id': entity.id}) }}">
  		<fieldset class="">
  			<label for="translate_source_language_code" class="input-label">Source language</label>
	  		<select id="translate_source_language_code" name="source_language_code">
				{% for language in languages %}
					<option value="{{ language.code }}" {{ app.request.query.get('source_language_code','en')==language.code ? "selected='true'" : '' }}>{{ language }}</option>
				{% endfor %}
			</select>

			<label for="translate_language_code" class="input-label">Target language</label>
			<select id="translate_language_code" name="language_code">
				{% for language in languages %}
					<option value="{{ language.code }}">{{ language }}</option>
				{% endfor %}
			</select>

			<label for="translate_category" class="input-label">Category</label>
			<select id="translate_category" name="category">
				<option value="">Any Category</option>
				{% for category in categories %}
					<option value="{{ category }}">
						{{ category }}
					</option>
				{% endfor %}
			</select>
			<button type="submit" class="btn btn-primary">Go!</button>
		</fieldset>
	</form>

	<h2>Download or (re)build GZIP</h2>

	<span class="form form-inline">
		<label for="gzip_language" class="input-label">Choose language</label>
		<select id="gzip_language" class="" name="gzip_language">
			<option value="" selected="true"></option>
			{% for language in languages %}
				<option value="{{ language.code }}">{{ language }}</option>
			{% endfor %}
		</select>
		<span id="generate_link"></span>
		<span id="download_link"></span>
	</span>

	<h2>Detailed statistics</h2>

	<table class="table">
	
		<tr>
			<th></th>
			{%  for cat in stats['categories'] %}
				<th>{{ cat | default("Overall")}}</th>
			{%  endfor %}
		</tr>
		{% for language, statistics in stats['statistics'] %}
			<tr class="translation_stat">
				<th>{{ language }}</th>
				{%  for cat in stats['categories'] %}
					<td
						class="clickable translation_stat"
					    style="background-color:{{ color_shade("#800","#080",statistics['statistics'][cat]['percent']/100, 0.7) }}; border: 1px solid {{ last_color_shade() }};" 
					    onclick="javascript:window.location='{{ path('translate', {'pack_id': entity.id, 'language_code': statistics['code'], 'category': cat}) }}'">
					    <span class="translation_stat_percent">{{ '%.1f' | format(statistics['statistics'][cat]['percent']) }}%</span>
					    <br/>({{ statistics['statistics'][cat]['translated'] }}/{{ statistics['statistics'][cat]['total'] }})
					</td>
				{%  endfor %}
			</tr>
		{% endfor %}
		<tr>
			<th></th>
			{%  for cat in stats['categories'] %}
				<th>{{ cat | default("Overall")}}</th>
			{%  endfor %}
		</tr>
	</table>
	
	<ul class="record_actions">
	    
	        <form action="{{ path('packs') }}" method="get">
	            <button type="submit" class="btn btn-link">&lt;&lt; Back to the list of Packs</button>
	        </form>
	    	    
	        
	    </li>
	    {% if is_granted('ROLE_SUPER_ADMIN') %}
	    	
		        <form action="{{ path('pack_setcurrent', { 'pack_id': entity.id }) }}" method="post" class="pull-left">
		            <button type="submit" class="btn btn-success input-large">Set as current pack</button>
		        </form>
		    	<form action="{{ path('pack_autocomplete', { 'pack_id': entity.id }) }}" method="post" class="pull-left">
		            <button type="submit" class="btn btn-primary input-large" >Autocomplete</button>
		        </form>
		       
		        <form action="{{ path('packs_delete', { 'id': entity.id }) }}" method="post" class="pull-right">
		            {{ form_widget(delete_form) }}
		            <button type="submit" class="btn btn-danger input-large">Delete</button>
		        </form>
		        <form action="{{ path('packs_edit', { 'id': entity.id }) }}" method="get" class="pull-right">
		            <button type="submit" class="btn btn-warning input-large">Edit</button>
		        </form>
		        
	    {% endif %}
	</ul>
{% endblock %}
